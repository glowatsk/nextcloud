version: "3"

services:
  db:
    image: mariadb
    restart: always
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    volumes:
      - ./db:/var/lib/mysql
    env_file:
      - db.env
    networks:
      - db

  redis:
    image: redis:alpine
    restart: always
    networks:
      - db

  app:
    image: nextcloud:stable
    restart: always
    volumes:
      - ./nextcloud-data:/var/www/html
      - ./nextcloud-data/config:/var/www/html/config
      - /media/nas:/var/www/html/data
    environment:
      - MYSQL_HOST=db
      - REDIS_HOST=redis
    env_file:
      - db.env
      - nextcloud.env
    depends_on:
      - db
      - redis
    labels:
      caddy: "${DOMAIN_NAME}"
      caddy.tls: "${DOMAIN_EMAIL}"
      caddy.file_server: ""
      caddy.root: "* /nextcloud/var/www/html"
      caddy.php_fastcgi: "{{upstreams 9000}}"
      caddy.php_fastcgi.root: "/var/www/html"
      caddy.php_fastcgi.env: "front_controller_active true"
      caddy.encode: gzip
      caddy.header: /*
      caddy.header.Strict-Transport-Security: '"max-age=15552000;"'
      caddy.redir_0: "/.well-known/carddav /remote.php/dav"
      caddy.redir_1: "/.well-known/caldav /remote.php/dav"
      caddy.@forbidden.path: "/.htaccess /data/* /config/* /db_structure /.xml /README /3rdparty/* /lib/* /templates/* /occ /console.php"
      caddy.respond: "@forbidden 403"
    networks:
      - caddy
      - db

  cron:
    image: nextcloud:stable
    restart: always
    volumes:
      - ./nextcloud-data:/var/www/html
    entrypoint: /cron.sh
    depends_on:
      - db
      - redis

volumes:
  db:
  nextcloud:

networks:
  caddy:
    external: true
  db:
